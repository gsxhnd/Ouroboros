"use strict";var M=Object.create;var S=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var H=Object.getOwnPropertyNames;var V=Object.getPrototypeOf,$=Object.prototype.hasOwnProperty;var K=(r,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of H(t))!$.call(r,s)&&s!==e&&S(r,s,{get:()=>t[s],enumerable:!(i=q(t,s))||i.enumerable});return r};var Q=(r,t,e)=>(e=r!=null?M(V(r)):{},K(t||!r||!r.__esModule?S(e,"default",{value:r,enumerable:!0}):e,r));var c=require("electron");var o=require("electron"),F=require("path"),v=class{tray;icon;constructor(){this.icon=o.nativeImage.createFromPath((0,F.resolve)("./resources/tray.png"))}init(){this.tray=new o.Tray(this.icon),this.tray.setToolTip("This is my application"),this.tray.setTitle("");let t=o.Menu.buildFromTemplate([{label:"Quit",type:"normal",checked:!0,click:()=>{console.log("quit click"),o.app.quit()}}]);this.tray.setContextMenu(t)}},E=new v;var U=Q(require("os"),1);var C=require("node:fs/promises");var d=require("node:fs/promises"),n=require("node:path"),T=require("node:url");function z(r){let t=r instanceof URL?(0,T.fileURLToPath)(r):r.toString();return(0,n.join)((0,n.dirname)(t),`.${(0,n.basename)(t)}.tmp`)}async function G(r,t,e){for(let i=0;i<t;i++)try{return await r()}catch(s){if(i<t-1)await new Promise(b=>setTimeout(b,e));else throw s}}var h=class{#t;#e;#r=!1;#a=null;#s=null;#o=null;#i=null;#n(t){return this.#i=t,this.#o||=new Promise((e,i)=>{this.#s=[e,i]}),new Promise((e,i)=>{this.#o?.then(e).catch(i)})}async#c(t){this.#r=!0;try{await(0,d.writeFile)(this.#e,t,"utf-8"),await G(async()=>{await(0,d.rename)(this.#e,this.#t)},10,100),this.#a?.[0]()}catch(e){throw e instanceof Error&&this.#a?.[1](e),e}finally{if(this.#r=!1,this.#a=this.#s,this.#s=this.#o=null,this.#i!==null){let e=this.#i;this.#i=null,await this.write(e)}}}constructor(t){this.#t=t,this.#e=z(t)}async write(t){return this.#r?this.#n(t):this.#c(t)}};var f=class{#t;#e;constructor(t){this.#t=t,this.#e=new h(t)}async read(){let t;try{t=await(0,C.readFile)(this.#t,"utf-8")}catch(e){if(e.code==="ENOENT")return null;throw e}return t}write(t){return this.#e.write(t)}};var m=class{#t;#e;#r;constructor(t,{parse:e,stringify:i}){this.#t=new f(t),this.#e=e,this.#r=i}async read(){let t=await this.#t.read();return t===null?null:this.#e(t)}write(t){return this.#t.write(this.#r(t))}};var u=class extends m{constructor(t){super(t,{parse:JSON.parse,stringify:e=>JSON.stringify(e,null,2)})}};var w=class{#t=null;read(){return Promise.resolve(this.#t)}write(t){return this.#t=t,Promise.resolve()}};function X(r,t){if(r===void 0)throw new Error("lowdb: missing adapter");if(t===void 0)throw new Error("lowdb: missing default data")}var y=class{adapter;data;constructor(t,e){X(t,e),this.adapter=t,this.data=e}async read(){let t=await this.adapter.read();t&&(this.data=t)}async write(){this.data&&await this.adapter.write(this.data)}async update(t){t(this.data),await this.write()}};async function L(r,t){let e=process.env.NODE_ENV==="test"?new w:new u(r),i=new y(e,t);return await i.read(),i}var l=require("electron"),D=require("path"),A=process.env.NODE_ENV==="dev"&&!l.app.isPackaged,R=l.app.isPackaged,g=(0,D.resolve)(l.app.getPath("home"),".config",l.app.getName()),k=(0,D.resolve)(g,"db.json");var J=require("fs/promises"),x=require("fs/promises");async function I(r){return await(0,x.access)(r,J.constants.F_OK).then(()=>!0).catch(()=>!1)}async function W(r){return await(0,x.mkdir)(r,{recursive:!0})}var j=require("electron"),_={os:U.default.platform(),appConfig:{libraries:[],useLanguage:""}},N=class{db;constructor(){}async init(){await I(g)||await W(g),_.appConfig.useLanguage=j.app.getSystemLocale(),await L(k,_).then(e=>{this.db=e}).catch(e=>{console.error(e)}),this.db.write()}async getPreferences(){return await this.db.read(),this.db.data}async setUseLibPath(t){for(let e of this.db.data.appConfig.libraries)(e.path=t)?e.use=!0:e.use=!1;this.db.data.appConfig.libraries.filter(e=>e.path===t)||(console.log("lib not exist"),this.db.data.appConfig.libraries.push({name:"123",path:t,use:!0}))}},p=new N;var a=require("electron"),P=require("path");var O=class{win;constructor(){}async init(){this.createWindow(),await this.loadHtml(),await this.loadIpc()}createWindow(){a.BrowserWindow.getAllWindows().length===0&&(this.win=new a.BrowserWindow({width:800,height:600,minHeight:600,minWidth:800,frame:!1,titleBarStyle:"hiddenInset",titleBarOverlay:!0,webPreferences:{devTools:!R,preload:(0,P.resolve)("dist/preload.cjs"),navigateOnDragDrop:!0}}))}async loadHtml(){A?(await a.session.defaultSession.loadExtension((0,P.resolve)("extension/vuetool_6.6.1_0")),this.win.webContents.openDevTools(),this.win.loadURL("http://localhost:3000")):this.win.loadFile("dist/renderer/index.html")}async loadIpc(){a.ipcMain.handle("loadPreferences",async t=>await p.getPreferences()),a.ipcMain.handle("dialog:newAssetLibPath",async(t,e)=>{let{canceled:i,filePaths:s}=await a.dialog.showOpenDialog(this.win,{properties:["openDirectory","createDirectory","promptToCreate"]});if(i)return i;let b=(0,P.resolve)(s[0],e);return console.log("new lib path:",b),!1}),a.ipcMain.handle("dialog:selectAssetLibPath",async t=>{let{canceled:e,filePaths:i}=await a.dialog.showOpenDialog(this.win,{properties:["openDirectory","createDirectory","promptToCreate"]});if(e)return null;let s=i[0];console.log("dialog:selectAssetLibPath"),await p.setUseLibPath(s)})}},B=new O;c.app.on("ready",async()=>{console.log("App on ready"),await p.init(),E.init()});c.app.on("activate",async()=>{console.log("App on activate")});c.app.whenReady().then(async()=>{console.log("App on when ready"),await B.init()});c.app.on("window-all-closed",()=>{process.platform!=="darwin"&&c.app.quit()});
